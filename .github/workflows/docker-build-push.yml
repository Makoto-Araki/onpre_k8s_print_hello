# -----------------------------------------------------------------------
# ワークフロー名: Pythonイメージのビルドとプッシュ
# 概要: バッチ処理をパッケージ化したDockerイメージを作成し、脆弱性診断と動作確認を経てDockerHubへ公開
# -----------------------------------------------------------------------
name: Build and Push Python Image

on:
  push:
    branches: [ main ]      # メインブランチへの更新時に自動実行
    tags: [ 'v*.*.*' ]      # v1.0.0などのタグ付与時にリリース用として実行

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. イメージのビルド
      - name: Build image
        run: docker build -t onpre_k8s_print_hello_image:local .

      # 2. 脆弱性スキャン (GitHub Advanced Securityの一環)
      - name: Run Vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'onpre_k8s_print_hello_image:local'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      # 3. 動作確認テスト
      - name: Run Functional Test
        run: |
          docker run --rm -v $(pwd):/app -w /app onpre_k8s_print_hello_image:local python tests/test_main.py

      # 4. DockerHubログイン
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. イメージプッシュ
      - name: Push to DockerHub
        run: |
          REPO=${{ secrets.DOCKERHUB_USERNAME }}/onpre_k8s_print_hello_image
          docker tag onpre_k8s_print_hello_image:local $REPO:latest
          docker push $REPO:latest
          
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${{ github.ref_name }}
            docker tag onpre_k8s_print_hello_image:local $REPO:$VERSION
            docker push $REPO:$VERSION
          fi